# Minimal nginx config for acceptance tests.
# Mirrors production topology: nginx sits in front of coordinator,
# rewrites /agent/mcp → /mcp, and proxies /agent/* REST endpoints.
# No TLS, no auth validation, no rate limiting.

upstream coordinator {
    server c3po-accept-coordinator:8420;
    keepalive 4;
}

server {
    listen 80;
    server_name _;

    # Health endpoint — no rewrite needed
    location = /api/health {
        proxy_pass http://coordinator;
    }

    # MCP endpoint — rewrite /agent/mcp to /mcp for FastMCP
    location = /agent/mcp {
        rewrite ^/agent(/mcp)$ $1 break;
        proxy_pass http://coordinator;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Connection "";
        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 3700s;
    }

    # Agent REST endpoints (register, unregister, pending)
    location /agent/ {
        proxy_pass http://coordinator;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Connection "";
        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 3700s;
    }

    # Deny everything else
    location / {
        return 404;
    }
}
